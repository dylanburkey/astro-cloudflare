---
import Dashboard from '../../../layouts/Dashboard.astro';
import { listStaticPresets, getPreset } from '../../../lib/presets/apply';
import { listCustomPresets } from '../../../lib/presets/custom';

// Get static presets with full data
const staticPresetInfos = listStaticPresets();
const staticPresets = await Promise.all(
  staticPresetInfos.map(async (info) => {
    const full = getPreset(info.slug);
    return { ...info, ...full, isCustom: false };
  })
);

// Get custom presets from D1
const customPresets = await listCustomPresets(Astro.locals);
const customPresetsFormatted = customPresets.map((cp) => ({
  slug: cp.slug,
  name: cp.name,
  description: cp.description || '',
  colors: cp.colors,
  typography: cp.typography,
  buttons: cp.buttons,
  isCustom: true,
}));

// Combine all presets
const allPresets = [...staticPresets, ...customPresetsFormatted];
---

<Dashboard title="Presets" activeNav="presets">
  <div class="mb-6 flex items-start justify-between">
    <div>
      <p class="text-gray-600">Color and typography presets you can apply to your projects.</p>
    </div>
    <a
      href="/library/presets/new"
      class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-colors inline-flex items-center gap-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Create Preset
    </a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {allPresets.map((preset) => (
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div
          class="h-24 flex items-center justify-center relative"
          style={`background-color: ${preset.colors?.background || '#fff'}`}
        >
          {preset.isCustom && (
            <span class="absolute top-2 right-2 px-2 py-0.5 text-xs bg-purple-100 text-purple-700 rounded-full">
              Custom
            </span>
          )}
          <div class="flex gap-2">
            <div
              class="w-8 h-8 rounded-full shadow-sm"
              style={`background-color: ${preset.colors?.primary || '#000'}`}
              title="Primary"
            ></div>
            <div
              class="w-8 h-8 rounded-full shadow-sm"
              style={`background-color: ${preset.colors?.secondary || '#333'}`}
              title="Secondary"
            ></div>
            <div
              class="w-8 h-8 rounded-full shadow-sm"
              style={`background-color: ${preset.colors?.accent || '#666'}`}
              title="Accent"
            ></div>
            <div
              class="w-8 h-8 rounded-full shadow-sm border"
              style={`background-color: ${preset.colors?.text || '#000'}`}
              title="Text"
            ></div>
          </div>
        </div>
        <div class="p-4">
          <h3 class="font-semibold text-gray-900 mb-1">{preset.name}</h3>
          <p class="text-sm text-gray-500 mb-3">{preset.description}</p>
          <div class="flex flex-wrap gap-2 text-xs">
            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded">
              {preset.typography?.heading_font?.replace(/_/g, ' ') || 'Default font'}
            </span>
            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded">
              {preset.buttons?.border_radius}px radius
            </span>
          </div>
        </div>
        <div class="px-4 py-3 bg-gray-50 border-t border-gray-100">
          <a
            href={`/library/presets/${preset.slug}`}
            class="text-sm text-emerald-600 hover:text-emerald-700 font-medium"
          >
            View Details
          </a>
        </div>
      </div>
    ))}
  </div>
</Dashboard>
