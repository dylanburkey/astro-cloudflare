---
interface Props {
  id: string;
  name: string;
  label: string;
  value: string;
  description?: string;
}

const { id, name, label, value, description } = Astro.props;
---

<div class="color-picker-field">
  <label for={id} class="color-label">{label}</label>
  {description && <p class="color-description">{description}</p>}
  <div class="color-input-wrapper">
    <input
      type="color"
      id={id}
      name={name}
      value={value}
      class="color-native-input"
    />
    <input
      type="text"
      id={`${id}-hex`}
      value={value}
      pattern="^#[0-9A-Fa-f]{6}$"
      maxlength="7"
      class="color-hex-input"
      data-color-id={id}
    />
    <div class="color-swatch" style={`background-color: ${value}`} data-swatch-id={id}></div>
  </div>
</div>

<script>
  // Sync color input with hex text input
  document.querySelectorAll('.color-picker-field').forEach((field) => {
    const colorInput = field.querySelector('input[type="color"]') as HTMLInputElement;
    const hexInput = field.querySelector('.color-hex-input') as HTMLInputElement;
    const swatch = field.querySelector('.color-swatch') as HTMLElement;

    if (!colorInput || !hexInput || !swatch) return;

    // Color picker -> hex input
    colorInput.addEventListener('input', () => {
      hexInput.value = colorInput.value;
      swatch.style.backgroundColor = colorInput.value;
    });

    // Hex input -> color picker
    hexInput.addEventListener('input', () => {
      let value = hexInput.value;

      // Add # if missing
      if (!value.startsWith('#')) {
        value = '#' + value;
      }

      // Validate hex format
      if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
        colorInput.value = value;
        swatch.style.backgroundColor = value;
        hexInput.classList.remove('invalid');
      } else {
        hexInput.classList.add('invalid');
      }
    });

    // Format on blur
    hexInput.addEventListener('blur', () => {
      let value = hexInput.value;
      if (!value.startsWith('#')) {
        value = '#' + value;
      }
      value = value.toUpperCase();
      if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
        hexInput.value = value;
        colorInput.value = value;
        swatch.style.backgroundColor = value;
      }
    });
  });
</script>

<style>
  .color-picker-field {
    margin-bottom: 1rem;
  }

  .color-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #1e293b;
    margin-bottom: 0.25rem;
  }

  .color-description {
    font-size: 0.75rem;
    color: #64748b;
    margin: 0 0 0.5rem;
  }

  .color-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .color-native-input {
    width: 3rem;
    height: 2.5rem;
    padding: 0.25rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    cursor: pointer;
    background: transparent;
  }

  .color-native-input::-webkit-color-swatch-wrapper {
    padding: 0;
  }

  .color-native-input::-webkit-color-swatch {
    border: none;
    border-radius: 0.25rem;
  }

  .color-hex-input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    font-family: monospace;
    font-size: 0.875rem;
    text-transform: uppercase;
  }

  .color-hex-input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .color-hex-input.invalid {
    border-color: #ef4444;
    background-color: #fef2f2;
  }

  .color-swatch {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.375rem;
    border: 1px solid #e2e8f0;
    flex-shrink: 0;
  }
</style>
