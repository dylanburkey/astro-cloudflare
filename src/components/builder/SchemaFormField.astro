---
/**
 * SchemaFormField - Renders form inputs based on Shopify section schema setting types
 * Supports: text, textarea, richtext, checkbox, select, range, color, url, image_picker, video, collection, product
 */

interface Setting {
  id: string;
  type: string;
  label: string;
  default?: unknown;
  info?: string;
  options?: { value: string; label: string }[];
  min?: number;
  max?: number;
  step?: number;
  unit?: string;
  placeholder?: string;
}

interface Props {
  setting: Setting;
  value?: unknown;
  sectionId: string;
}

const { setting, value, sectionId } = Astro.props;

// Determine current value (use provided value, or default, or empty)
const currentValue = value ?? setting.default ?? '';
const fieldId = `${sectionId}-${setting.id}`;
const fieldName = `settings[${setting.id}]`;

// Range defaults
const rangeMin = setting.min ?? 0;
const rangeMax = setting.max ?? 100;
const rangeStep = setting.step ?? 1;
---

<div class="schema-field" data-field-id={setting.id} data-field-type={setting.type}>
  <label for={fieldId} class="field-label">
    {setting.label}
  </label>

  {setting.info && (
    <p class="field-info">{setting.info}</p>
  )}

  {/* Text input */}
  {setting.type === 'text' && (
    <input
      type="text"
      id={fieldId}
      name={fieldName}
      value={String(currentValue)}
      placeholder={setting.placeholder || ''}
      class="field-input"
      data-setting-id={setting.id}
    />
  )}

  {/* Textarea */}
  {setting.type === 'textarea' && (
    <textarea
      id={fieldId}
      name={fieldName}
      placeholder={setting.placeholder || ''}
      class="field-textarea"
      rows="3"
      data-setting-id={setting.id}
    >{String(currentValue)}</textarea>
  )}

  {/* Rich text - simplified as textarea for now */}
  {setting.type === 'richtext' && (
    <textarea
      id={fieldId}
      name={fieldName}
      placeholder={setting.placeholder || 'Enter HTML content...'}
      class="field-textarea field-richtext"
      rows="4"
      data-setting-id={setting.id}
    >{String(currentValue)}</textarea>
  )}

  {/* Checkbox */}
  {setting.type === 'checkbox' && (
    <label class="field-checkbox">
      <input
        type="checkbox"
        id={fieldId}
        name={fieldName}
        checked={Boolean(currentValue)}
        class="checkbox-input"
        data-setting-id={setting.id}
      />
      <span class="checkbox-toggle"></span>
      <span class="checkbox-label-text">Enabled</span>
    </label>
  )}

  {/* Select dropdown */}
  {setting.type === 'select' && (
    <select
      id={fieldId}
      name={fieldName}
      class="field-select"
      data-setting-id={setting.id}
    >
      {setting.options?.map((option) => (
        <option value={option.value} selected={option.value === currentValue}>
          {option.label}
        </option>
      ))}
      {!setting.options && (
        <>
          <option value="left" selected={currentValue === 'left'}>Left</option>
          <option value="center" selected={currentValue === 'center'}>Center</option>
          <option value="right" selected={currentValue === 'right'}>Right</option>
        </>
      )}
    </select>
  )}

  {/* Range slider */}
  {setting.type === 'range' && (
    <div class="field-range-wrapper">
      <input
        type="range"
        id={fieldId}
        name={fieldName}
        value={String(currentValue)}
        min={rangeMin}
        max={rangeMax}
        step={rangeStep}
        class="field-range"
        data-setting-id={setting.id}
      />
      <div class="range-value">
        <input
          type="number"
          value={String(currentValue)}
          min={rangeMin}
          max={rangeMax}
          step={rangeStep}
          class="range-number-input"
          data-range-target={fieldId}
        />
        {setting.unit && <span class="range-unit">{setting.unit}</span>}
      </div>
    </div>
  )}

  {/* Color picker */}
  {setting.type === 'color' && (
    <div class="field-color-wrapper">
      <input
        type="color"
        id={fieldId}
        name={fieldName}
        value={String(currentValue).startsWith('#') ? String(currentValue).slice(0, 7) : '#000000'}
        class="color-input"
        data-setting-id={setting.id}
      />
      <input
        type="text"
        value={String(currentValue)}
        pattern="^#[0-9A-Fa-f]{6,8}$"
        maxlength="9"
        class="color-hex-input"
        data-color-target={fieldId}
      />
      <div
        class="color-swatch"
        style={`background-color: ${currentValue}`}
      ></div>
    </div>
  )}

  {/* URL input */}
  {setting.type === 'url' && (
    <input
      type="url"
      id={fieldId}
      name={fieldName}
      value={String(currentValue)}
      placeholder={setting.placeholder || 'https://...'}
      class="field-input field-url"
      data-setting-id={setting.id}
    />
  )}

  {/* Image picker - placeholder UI */}
  {setting.type === 'image_picker' && (
    <div class="field-image-picker">
      <div class="image-preview">
        {currentValue ? (
          <img src={String(currentValue)} alt="Selected image" class="preview-img" />
        ) : (
          <div class="image-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>No image selected</span>
          </div>
        )}
      </div>
      <input
        type="text"
        id={fieldId}
        name={fieldName}
        value={String(currentValue)}
        placeholder="Enter image URL or path"
        class="field-input"
        data-setting-id={setting.id}
      />
    </div>
  )}

  {/* Video - similar to image picker */}
  {setting.type === 'video' && (
    <div class="field-video-picker">
      <input
        type="text"
        id={fieldId}
        name={fieldName}
        value={String(currentValue)}
        placeholder="Enter video URL"
        class="field-input"
        data-setting-id={setting.id}
      />
      <p class="field-hint">Supports YouTube, Vimeo, or direct video URLs</p>
    </div>
  )}

  {/* Collection picker - simplified as text input */}
  {setting.type === 'collection' && (
    <input
      type="text"
      id={fieldId}
      name={fieldName}
      value={String(currentValue)}
      placeholder="Enter collection handle"
      class="field-input"
      data-setting-id={setting.id}
    />
  )}

  {/* Product picker - simplified as text input */}
  {setting.type === 'product' && (
    <input
      type="text"
      id={fieldId}
      name={fieldName}
      value={String(currentValue)}
      placeholder="Enter product handle"
      class="field-input"
      data-setting-id={setting.id}
    />
  )}
</div>

<style>
  .schema-field {
    margin-block-end: 1rem;
  }

  .field-label {
    display: block;
    font-size: 0.8125rem;
    font-weight: 500;
    color: #1e293b;
    margin-block-end: 0.25rem;
  }

  .field-info {
    font-size: 0.75rem;
    color: #64748b;
    margin: 0 0 0.5rem;
    line-height: 1.4;
  }

  .field-hint {
    font-size: 0.6875rem;
    color: #94a3b8;
    margin: 0.25rem 0 0;
  }

  .field-input,
  .field-textarea,
  .field-select {
    inline-size: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #1e293b;
    background: white;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .field-input:focus,
  .field-textarea:focus,
  .field-select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .field-textarea {
    resize: vertical;
    min-block-size: 4rem;
  }

  .field-richtext {
    font-family: monospace;
    font-size: 0.8125rem;
  }

  /* Checkbox toggle switch */
  .field-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .checkbox-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .checkbox-toggle {
    position: relative;
    inline-size: 2.5rem;
    block-size: 1.25rem;
    background: #e2e8f0;
    border-radius: 9999px;
    transition: background 0.2s;
  }

  .checkbox-toggle::after {
    content: '';
    position: absolute;
    inset-block-start: 0.125rem;
    inset-inline-start: 0.125rem;
    inline-size: 1rem;
    block-size: 1rem;
    background: white;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s;
  }

  .checkbox-input:checked + .checkbox-toggle {
    background: #6366f1;
  }

  .checkbox-input:checked + .checkbox-toggle::after {
    transform: translateX(1.25rem);
  }

  .checkbox-label-text {
    font-size: 0.875rem;
    color: #475569;
  }

  /* Range slider */
  .field-range-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .field-range {
    flex: 1;
    block-size: 0.375rem;
    border-radius: 9999px;
    background: #e2e8f0;
    appearance: none;
    cursor: pointer;
  }

  .field-range::-webkit-slider-thumb {
    appearance: none;
    inline-size: 1rem;
    block-size: 1rem;
    background: #6366f1;
    border-radius: 50%;
    cursor: grab;
    transition: transform 0.15s;
  }

  .field-range::-webkit-slider-thumb:hover {
    transform: scale(1.1);
  }

  .field-range::-webkit-slider-thumb:active {
    cursor: grabbing;
  }

  .range-value {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    min-inline-size: 4rem;
  }

  .range-number-input {
    inline-size: 3.5rem;
    padding: 0.25rem 0.375rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    text-align: center;
  }

  .range-number-input:focus {
    outline: none;
    border-color: #6366f1;
  }

  .range-unit {
    font-size: 0.75rem;
    color: #64748b;
  }

  /* Color picker */
  .field-color-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .color-input {
    inline-size: 2.5rem;
    block-size: 2.25rem;
    padding: 0.125rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    cursor: pointer;
    background: transparent;
  }

  .color-input::-webkit-color-swatch-wrapper {
    padding: 0;
  }

  .color-input::-webkit-color-swatch {
    border: none;
    border-radius: 0.25rem;
  }

  .color-hex-input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    font-family: monospace;
    font-size: 0.8125rem;
    text-transform: uppercase;
  }

  .color-hex-input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .color-swatch {
    inline-size: 2.25rem;
    block-size: 2.25rem;
    border-radius: 0.375rem;
    border: 1px solid #e2e8f0;
    flex-shrink: 0;
  }

  /* Image picker */
  .field-image-picker {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .image-preview {
    inline-size: 100%;
    aspect-ratio: 16 / 9;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-img {
    inline-size: 100%;
    block-size: 100%;
    object-fit: cover;
  }

  .image-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: #94a3b8;
  }

  .image-placeholder svg {
    inline-size: 2rem;
    block-size: 2rem;
  }

  .image-placeholder span {
    font-size: 0.75rem;
  }

  /* Video picker */
  .field-video-picker {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
</style>
